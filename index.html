<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <h1>
    Welcome to NilesoftEditor
  </h1>
  <h6>developed by ArcadeFortune</h6>

  <form action="/taskbar" method="post" enctype="application/json">
    <input type="number" name="position" value="23">
    <input type="text" name="section" value="item">
    <input type="text" name="title" value="test">
    <input type="text" name="imagePath">
    <input type="text" name="cmd" value="rito.bat">
    <select name="sep">
      <option value="both">Above and Below</option>
      <option value="top">Above</option>
      <option value="bottom">Below</option>
    </select>
    <input type="submit" value="Upload">
  </form>


  <button onclick="apply()">testapply</button>


  <br/>
  <button onclick="getTaskbar()">Get Taskbar</button>
  <br/>
  <div class="context-menu">
    <div class="element">
      <div class="menu">
        Nilesoft (clickable (not really))
      </div>
    </div>
    <div class="element">
      <div class="menu">
        Apps (clickable (not really))
      </div>
    </div>
    <div class="element">
      <div class="menu">
        Riot Games (clickable (not really))
      </div>
    </div>
    <div class="element">
      <div class="item">
        Settings
      </div>
    </div>
    <div class="element">
      <div class="item">
        Task Manager
      </div>
    </div>
    <div class="element">
      <div class="item">
        Exit Explorer
      </div>
    </div>
  </div>
  <br/>
  <div id="main">
  </div>
  <script>
    let menusToDelete = {};
    function apply() {
      fetch('/apply')
    }
    function getTaskbar() {
      fetch('/taskbar')
      .then(res => res.json())
      .then(data => {
        const root = document.createElement('div')
        root.className = 'context-menu';

        data.forEach(element => {
          if (element['menu']) {
            const currentMenu = element['menu'];
            //check if it is expanded
            if (currentMenu.expanded) {
              root.append(getChildren(currentMenu.children));
            } else {
              console.log('found folder:');
              const parent = document.createElement('div');
              parent.className = 'element';
              const child = document.createElement('div');
              child.className = 'menu';
              child.innerText = currentMenu.title;
              parent.appendChild(child);
              root.appendChild(parent);
            }
          }
        })
        document.querySelector('#main').appendChild(root);
      })
    }

    function getChildren(array, depth = 0) {
      const fragment = document.createDocumentFragment();

      //loop over every element
      array.forEach(element => {
        const div = document.createElement('div');
        div.className = 'element';

        const child = document.createElement('div');

        if (element['menu']) {
          child.className = 'menu';
          child.innerText = element['menu'].title;

          //preping for nested menus
          const newMenu = generateContextMenuDiv(element['menu'].children, depth + 1);
          div.onclick = (event) => {
            removeContextMenus(depth);
            appendContextMenu(newMenu, depth);
            console.log(depth);
          }
        } else {
          child.className = 'item';
          child.innerText = element['item'].title;
        }
        div.appendChild(child);
        fragment.appendChild(div);
        console.log(element);
      })
      return fragment;
    }
    function generateContextMenuDiv(array, depth = 0) { 
      const div = document.createElement('div')
      div.className = 'context-menu';
      div.append(getChildren(array, depth));
      return div;
    }
    function appendContextMenu(menu, depth) {
      document.querySelector('#main').appendChild(menu);
      menusToDelete[depth] = menu;
    }
    function removeContextMenus(depth) {
      while (true) {
        if (menusToDelete[depth]) {
          menusToDelete[depth].remove();
          delete menusToDelete[depth];
          depth++;
        } else {
          break;
        }
      }
    }
    document.body.onclick = () => {
      if (event.target === document.body) removeContextMenus(0);
      //okay so every onclick event will trigger this function btw, because of propagation
    }
    document.querySelector('#main').onclick = (event) => {
      if (event.target === document.querySelector('#main')) removeContextMenus(0);
      //same here ðŸ˜”
    }
  </script>
</body>
</html>